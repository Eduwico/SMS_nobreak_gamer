#!/usr/bin/with-contenv bashio
set -euxo pipefail
# ==============================================================================
# Home Assistant Add-on: SMS Gamer UPS Monitor - Vers√£o Melhorada
# This script starts the Python monitoring script with configurations from the add-on options.
# 
# Melhorias implementadas:
# - Suporte aos novos par√¢metros configur√°veis (baud_rate, timeout)
# - N√£o loga informa√ß√µes sens√≠veis (senhas)
# - Valida√ß√£o b√°sica de par√¢metros
# - Logs mais informativos
# ==============================================================================
echo "ü™´ Add-on SMS UPS"
# Read add-on options using bashio
SERIAL_PORT=$(bashio::config "serial_port")
POLL_INTERVAL=$(bashio::config "poll_interval")
BAUD_RATE=$(bashio::config "baud_rate")
TIMEOUT=$(bashio::config "timeout")
MQTT_BROKER=$(bashio::config "mqtt_broker")
MQTT_PORT=$(bashio::config "mqtt_port")
MQTT_USERNAME=$(bashio::config "mqtt_username")
MQTT_PASSWORD=$(bashio::config "mqtt_password")

bashio::log.info "=========================================="
bashio::log.info "SMS Gamer UPS Monitor - Vers√£o Melhorada"
bashio::log.info "=========================================="
bashio::log.info "Porta Serial: ${SERIAL_PORT}"
bashio::log.info "Intervalo de Leitura: ${POLL_INTERVAL}s"
bashio::log.info "Baudrate: ${BAUD_RATE}"
bashio::log.info "Timeout: ${TIMEOUT}s"
bashio::log.info "Broker MQTT: ${MQTT_BROKER}:${MQTT_PORT}"
bashio::log.info "Usu√°rio MQTT: ${MQTT_USERNAME}"
# N√£o loga a senha por quest√µes de seguran√ßa

# Valida√ß√£o b√°sica de par√¢metros
if [[ -z "${SERIAL_PORT}" ]]; then
    bashio::log.fatal "Porta serial n√£o configurada!"
    exit 1
fi

if [[ -z "${MQTT_BROKER}" ]]; then
    bashio::log.fatal "Broker MQTT n√£o configurado!"
    exit 1
fi

if [[ -z "${MQTT_USERNAME}" ]] || [[ -z "${MQTT_PASSWORD}" ]]; then
    bashio::log.warning "Credenciais MQTT n√£o configuradas. Tentando conex√£o sem autentica√ß√£o..."
fi

# Verifica se a porta serial existe
if [[ ! -e "${SERIAL_PORT}" ]]; then
    bashio::log.warning "Porta serial ${SERIAL_PORT} n√£o encontrada. Verifique a conex√£o do dispositivo."
fi

bashio::log.info "Iniciando monitoramento..."

# Execute o script Python, passando as configura√ß√µes como argumentos
exec python3 sms_gamer_ups_monitor.py \
    --port "${SERIAL_PORT}" \
    --interval "${POLL_INTERVAL}" \
    --baud-rate "${BAUD_RATE}" \
    --timeout "${TIMEOUT}" \
    --mqtt-broker "${MQTT_BROKER}" \
    --mqtt-port "${MQTT_PORT}" \
    --mqtt-username "${MQTT_USERNAME}" \
    --mqtt-password "${MQTT_PASSWORD}" \
    --mqtt # Ativa o modo MQTT do script \
    --mqtt \
    --verbose
